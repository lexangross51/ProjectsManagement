@model Projects.Presentation.Models.Projects.UpdateProjectDto

@{
    Layout = null;
}

<!DOCTYPE html>

<html lang="en">
<head>
    <title>Edit project</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.3/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.3/jquery-ui.min.js"></script>
</head>
<body>
    <form asp-action="UpdateProject" asp-controller="Project" method="post">
        @Html.AntiForgeryToken()
        <div>
            <label asp-for="ProjectName">Project name: </label>
            <input asp-for="ProjectName" />
            <span asp-validation-for="ProjectName"></span>
        </div>
        <div>
            <label asp-for="CompanyCustomer">Customer company: </label>
            <input asp-for="CompanyCustomer" />
            <span asp-validation-for="CompanyCustomer"></span>
        </div>
        <div>
            <label asp-for="CompanyExecutor">Executor company: </label>
            <input asp-for="CompanyExecutor" />
            <span asp-validation-for="CompanyExecutor"></span>
        </div>
        <div>
            <label asp-for="Priority">Priority: </label>
            <input asp-for="Priority" />
            <span asp-validation-for="Priority"></span>
        </div>
        <div>
            <label asp-for="DateStart">Date start: </label>
            <input type="date" asp-for="DateStart" />
            <span asp-validation-for="DateStart"></span>
        </div>
        <div>
            <label asp-for="DateEnd">Date end: </label>
            <input type="date" asp-for="DateEnd" />
            <span asp-validation-for="DateEnd"></span>
        </div>
        <div>
            <label>Manager: </label>
            <input type="text" id="managerName" value="@Model.Manager?.FullName"/>
            <input type="hidden" id="managerId" asp-for="ManagerId"/>

            <script type="text/javascript">
                $(document).ready(function () {
                    $('#managerName').autocomplete({
                        source: function (request, response) {
                            $.ajax({
                                url: '/Project/Employees/',
                                type: 'GET',
                                data: { term: request.term },
                                success: function (data) {
                                    response($.map(data, function (item) {
                                        return { label: item.value, value: item.id }
                                    }))
                                }
                            });
                        },
                        select: function (event, ui) {
                            $('#managerName').val(ui.item.label);
                            $('#managerId').val(ui.item.value);
                            return false;
                        }
                    }).on('mousedown', function () {
                        $(this).autocomplete("search", " ");
                    });
                });
            </script>
        </div>

        <div>
            <label>Executors: </label>
            <input type="text" id="executorsNames" />
            <input type="hidden" id="executorsId" asp-for="ExecutorsId" />
            <ul id="selectedExecutors">
                @if (Model.Executors != null)
                {
                    foreach (var e in Model.Executors)
                    {
                        <li data-id="@e.Id"> @e.FullName <button class="remove"> X </button></li>
                    }
                }
            </ul>

            <script type="text/javascript">
                $(document).ready(function () {
                    const selectedExecutors = $('#selectedExecutors');

                    $('#executorsNames').autocomplete({
                        source: function (request, response) {
                            $.ajax({
                                url: '/Project/Employees/',
                                type: 'GET',
                                data: { term: request.term },
                                success: function (data) {
                                    response($.map(data, function (item) {
                                        return { label: item.value, value: item.id }
                                    }))
                                }
                            });
                        },
                        select: function (event, ui) {
                            selectedExecutors.append('<li data-id="' + ui.item.value + '">' + ui.item.label + ' <button class="remove"> X </button></li>');
                            updateSelectedExecutorsList();
                            return false;
                        }
                    }).on('mousedown', function () {
                        $(this).autocomplete("search", " ");
                    })

                    selectedExecutors.on("click", ".remove", function () {
                        $(this).parent().remove();
                        updateSelectedExecutorsList();
                    })

                    function updateSelectedExecutorsList() {
                        const selectedExecutors = $("#selectedExecutors li").map(function () {
                            return $(this).data('id');
                        }).get().join(",");

                        $('#executorsId').val(selectedExecutors);
                    }
                })
            </script>
        </div>

        <div>
            <input type="submit" value="Update" />
        </div>
    </form>
</body>
</html>